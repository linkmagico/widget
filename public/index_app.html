<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkMágico v7.0 - IA Conversacional Inteligente para Vendas Online</title>
    <meta name="description" content="Nova geração de chatbot com IA avançada, extração universal de dados e deep linking multiplataforma. Transforme suas páginas de vendas em conversas inteligentes.">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #60a5fa;
            --secondary: #8b5cf6;
            --accent: #06d6a0;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --dark: #0f172a;
            --dark-surface: #1e293b;
            --dark-elevated: #334155;
            --dark-border: #475569;
            --dark-text: #f8fafc;
            --dark-text-secondary: #cbd5e1;
            --dark-text-muted: #94a3b8;
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            --gradient-success: linear-gradient(135deg, var(--success) 0%, var(--accent) 100%);
            --gradient-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            --border-subtle: rgba(148, 163, 184, 0.1);
            --glass-bg: rgba(30, 41, 59, 0.8);
            --glass-border: rgba(148, 163, 184, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gradient-bg);
            min-height: 100vh;
            color: var(--dark-text);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            background: rgba(15, 23, 42, 0.9);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            box-shadow: var(--shadow-md);
        }
        
        .logo-text h1 {
            font-size: 1.4rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }
        
        .version-badge {
            background: var(--gradient-success);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-md);
            margin-left: 0.5rem;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(16, 185, 129, 0.1);
            padding: 0.6rem 1.2rem;
            border-radius: 24px;
            border: 1px solid rgba(16, 185, 129, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .status-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--success);
        }
        
        .lgpd-badge {
            cursor: pointer;
            background: rgba(59, 130, 246, 0.1);
            padding: 0.6rem 1.2rem;
            border-radius: 24px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary-light);
        }
        
        .lgpd-badge:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem 2rem 2rem;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2rem;
            min-height: calc(100vh - 140px);
        }
        
        /* Control Panel */
        .control-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            height: fit-content;
            box-shadow: var(--shadow-xl);
            position: sticky;
            top: 120px;
        }
        
        .panel-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .panel-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
        }
        
        .panel-subtitle {
            color: var(--dark-text-secondary);
            font-size: 0.9rem;
        }
        
        .success-alert {
            background: var(--gradient-success);
            color: white;
            padding: 1.2rem;
            border-radius: 16px;
            margin-bottom: 1.5rem;
            font-weight: 600;
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }
        
        .success-alert::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .form-section {
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark-text);
            font-size: 0.9rem;
        }
        
        .form-label i {
            color: var(--primary-light);
            width: 16px;
        }
        
        .form-input {
            width: 100%;
            padding: 0.875rem 1.2rem;
            border: 2px solid var(--dark-border);
            border-radius: 12px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: var(--dark-surface);
            color: var(--dark-text);
        }
        
        .form-input::placeholder {
            color: var(--dark-text-muted);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            background: var(--dark-elevated);
        }
        
        .form-textarea {
            min-height: 90px;
            resize: vertical;
            font-family: inherit;
        }
        
        .input-hint {
            font-size: 0.75rem;
            color: var(--dark-text-muted);
            margin-top: 0.25rem;
            font-style: italic;
        }
        
        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-lg);
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.4);
        }
        
        /* ===== NOVA SEÇÃO: LINK DO CHATBOT ===== */
        .chatbot-link-section {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .chatbot-link-section.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chatbot-link-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chatbot-link-url {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
            word-break: break-all;
            position: relative;
        }
        
        .chatbot-link-url a {
            color: var(--primary-light);
            text-decoration: none;
            font-weight: 600;
        }
        
        .chatbot-link-url a:hover {
            text-decoration: underline;
        }
        
        .copy-link-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--primary-light);
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .copy-link-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }
        
        .extracted-data-section {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 1.2rem;
            margin-top: 1rem;
        }
        
        .extracted-data-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
        }
        
        .extracted-data-content {
            font-size: 0.8rem;
            color: var(--dark-text-secondary);
            line-height: 1.4;
        }
        
        .social-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.6rem;
            margin-top: 1.5rem;
        }
        
        .social-btn {
            padding: 0.8rem 0.4rem;
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.7rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            position: relative;
            overflow: hidden;
        }
        
        .social-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }
        
        .social-btn i {
            font-size: 1.1rem;
        }
        
        .whatsapp { background: linear-gradient(135deg, #25d366, #1ebe57); }
        .instagram { background: linear-gradient(135deg, #f09433, #dc2743, #cc2366, #bc1888); }
        .facebook { background: linear-gradient(135deg, #1877f2, #0c63d4); }
        .youtube { background: linear-gradient(135deg, #ff0000, #cc0000); }
        .tiktok { background: linear-gradient(135deg, #000000, #333333); }
        .twitter { background: linear-gradient(135deg, #1da1f2, #0c7abf); }
        .kwai { background: linear-gradient(135deg, #ff6600, #e55100); }
        .linkedin { background: linear-gradient(135deg, #0077b5, #005885); }
        .telegram { background: linear-gradient(135deg, #0088cc, #006699); }
        .messenger { background: linear-gradient(135deg, #006aff, #0056cc); }
        .prompt { background: linear-gradient(135deg, #10b981, #059669); }
        .analytics { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        
        /* Dashboard */
        .dashboard {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .dashboard-header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: var(--shadow-xl);
            position: relative;
        }
        
        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 24px 24px 0 0;
        }
        
        .dashboard-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
        }
        
        .dashboard-subtitle {
            color: var(--dark-text-secondary);
            font-size: 0.95rem;
        }
        
        /* Analytics Cards */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.2rem;
        }
        
        .analytics-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .analytics-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }
        
        .analytics-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-weight: 600;
            color: var(--dark-text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card-icon {
            width: 36px;
            height: 36px;
            background: var(--gradient-primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            box-shadow: var(--shadow-md);
        }
        
        .card-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--dark-text);
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .card-change {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--success);
        }
        
        /* Chat Preview */
        .chat-preview {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 400px;
        }
        
        .chat-header {
            padding: 1.2rem 1.5rem;
            background: var(--gradient-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        
        .chat-header::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }
        
        .chat-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1.2rem;
            overflow-y: auto;
            background: var(--dark-surface);
        }
        
        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-end;
            gap: 0.6rem;
        }
        
        .message.user {
            justify-content: flex-end;
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            flex-shrink: 0;
            box-shadow: var(--shadow-md);
        }
        
        .user .message-avatar {
            background: var(--gradient-success);
        }
        
        .message-content {
            max-width: 70%;
            padding: 0.8rem 1rem;
            border-radius: 16px;
            font-size: 0.85rem;
            line-height: 1.4;
            box-shadow: var(--shadow-sm);
        }
        
        .bot .message-content {
            background: var(--dark-elevated);
            color: var(--dark-text);
            border: 1px solid var(--dark-border);
        }
        
        .user .message-content {
            background: var(--gradient-primary);
            color: white;
        }
        
        .chat-input {
            padding: 1.2rem;
            background: var(--dark-surface);
            border-top: 1px solid var(--dark-border);
        }
        
        .input-group {
            display: flex;
            gap: 0.8rem;
            align-items: center;
        }
        
        .chat-input-field {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 2px solid var(--dark-border);
            border-radius: 20px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            background: var(--dark-elevated);
            color: var(--dark-text);
        }
        
        .chat-input-field::placeholder {
            color: var(--dark-text-muted);
        }
        
        .chat-input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .send-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }
        
        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }
        
        /* Widget Code Generator */
        .widget-generator {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: var(--shadow-xl);
        }
        
        .widget-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .code-block {
            background: var(--dark);
            color: var(--accent);
            padding: 1.5rem;
            border-radius: 16px;
            font-family: 'Monaco', 'Consolas', 'Fira Code', monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            overflow-x: auto;
            position: relative;
            margin-top: 0.75rem;
            border: 1px solid var(--dark-border);
        }
        
        .copy-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--primary-light);
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .copy-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }
        
        /* Loading States */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--dark-border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            margin: 0 auto 1rem;
        }
        
        .spinner.active {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .typing-indicator {
            display: none;
            padding: 1rem 2rem;
            color: var(--dark-text-secondary);
            font-style: italic;
            text-align: center;
        }
        
        /* Results */
        .result {
            display: none;
        }
        
        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }
        
        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        
        .toast {
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            min-width: 250px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.success {
            background-color: var(--success);
        }
        
        .toast.error {
            background-color: var(--error);
        }
        
        .toast i {
            font-size: 1.2em;
        }
        
        /* Privacy Footer */
        .privacy-footer {
            text-align: center;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.8);
            border-top: 1px solid var(--glass-border);
            margin-top: 2rem;
            font-size: 0.8rem;
            color: var(--dark-text-muted);
        }
        
        .privacy-footer a {
            color: var(--primary-light);
            text-decoration: none;
        }
        
        .privacy-footer a:hover {
            text-decoration: underline;
        }
        
        /* Consent Modal */
        .consent-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .consent-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .consent-content {
            background: var(--dark-surface);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            max-width: 500px;
            width: 100%;
            position: relative;
            z-index: 1001;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }
        
        .consent-header {
            background: var(--gradient-primary);
            color: white;
            padding: 1.5rem;
            text-align: center;
            position: relative;
        }
        
        .consent-header h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .consent-body {
            padding: 1.5rem;
        }
        
        .consent-warning {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .consent-warning i {
            color: var(--warning);
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .consent-details p {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .consent-details ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            color: var(--dark-text-secondary);
        }
        
        .legal-basis {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid var(--primary);
            padding: 0.5rem 1rem;
            margin: 1rem 0;
            font-size: 0.85rem;
            color: var(--primary-light);
        }
        
        .url-verification {
            margin: 1.5rem 0;
        }
        
        .url-verification label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .robots-check {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--dark-text-muted);
            font-style: italic;
        }
        
        .consent-footer {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .btn-secondary {
            flex: 1;
            padding: 1rem;
            border: 1px solid var(--dark-border);
            background: transparent;
            color: var(--dark-text);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: var(--dark-elevated);
        }
        
        .btn-primary-consent {
            flex: 1;
            background: var(--gradient-primary);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary-consent:hover {
            opacity: 0.9;
        }
        
        .consent-links {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.85rem;
        }
        
        .consent-links a {
            color: var(--primary-light);
            text-decoration: none;
            margin: 0 0.5rem;
        }
        
        .consent-links a:hover {
            text-decoration: underline;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--dark-surface);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--dark-border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 0 1rem 1rem 1rem;
            }
        
            .control-panel {
                position: static;
                top: auto;
            }
        
            .header-content {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
        
            .status-indicator, .lgpd-badge {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
        
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        
            .chat-preview {
                height: 300px;
            }
        
            .consent-content {
                margin: 1rem;
            }
            
            .social-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-robot"></i></div>
                <div class="logo-text">
                    <h1>LinkMágico</h1>
                    <span class="version-badge">v7.0</span>
                </div>
            </div>
            <div style="display: flex; gap: 1rem;">
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Sistema Online</span>
                </div>
                <div class="lgpd-badge" id="lgpdBadge">
                    <span>Conforme LGPD</span>
                </div>
            </div>
        </div>
    </header>

    <main class="main-container">
        <div class="control-panel">
            <div class="panel-header">
                <h2 class="panel-title">Criar Chatbot</h2>
                <p class="panel-subtitle">Configure seu assistente de vendas inteligente</p>
            </div>

            <div class="success-alert" id="successAlert" style="display: none;">
                Sua IA Conversacional está pronta para impulsionar suas vendas!
            </div>

            <div class="form-section">
                <div class="form-group">
                    <label for="robotName" class="form-label"><i class="fas fa-robot"></i> Nome do Assistente Virtual:</label>
                    <input type="text" id="robotName" class="form-input" value="@teste" placeholder="Ex: @AssistenteDeVendas">
                </div>
                <div class="form-group">
                    <label for="salesUrl" class="form-label"><i class="fas fa-link"></i> URL da Página:</label>
                    <input type="url" id="salesUrl" class="form-input" value="https://www.arsenalsecretodosceos.com.br" placeholder="Ex: https://seusite.com/pagina-de-vendas">
                    <p class="input-hint">A URL deve ser da sua página de vendas ou de conteúdo relevante.</p>
                </div>
                <div class="form-group">
                    <label for="customInstructions" class="form-label"><i class="fas fa-comment-dots"></i> Instruções Personalizadas (opcional):</label>
                    <textarea id="customInstructions" class="form-input form-textarea" placeholder="Ex: Sempre responda de forma amigável, consultiva e entusiasmada, mas objetiva">Sempre responda de forma amigável, consultiva e entusiasmada, mas objetiva</textarea>
                    <p class="input-hint">Dica: peça respostas curtas (2-3 frases), objetivas e sem repetições.</p>
                </div>
                <button class="btn btn-primary" id="activateChatbotBtn">
                    <i class="fas fa-play-circle"></i> Ativar Chatbot Inteligente
                </button>
            </div>

            <!-- ===== NOVA SEÇÃO: LINK DO CHATBOT ===== -->
            <div class="chatbot-link-section" id="chatbotLinkSection">
                <div class="chatbot-link-title">
                    <i class="fas fa-link"></i> Link do Chatbot:
                </div>
                <div class="chatbot-link-url">
                    <a href="#" id="chatbotLinkUrl" target="_blank">Clique aqui para acessar seu chatbot</a>
                    <button class="copy-link-btn" id="copyChatbotLinkBtn">
                        <i class="fas fa-copy"></i> Copiar
                    </button>
                </div>
                
                <div class="extracted-data-section">
                    <div class="extracted-data-title">Dados Extraídos:</div>
                    <div class="extracted-data-content" id="extractedDataContent">
                        <strong>Resumo:</strong> <span id="extractedSummary">Os dados serão carregados após a ativação...</span>
                    </div>
                </div>
            </div>

            <div class="social-grid">
                <button class="social-btn whatsapp" id="shareWhatsApp"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                <button class="social-btn instagram" id="shareInstagram"><i class="fab fa-instagram"></i> Instagram</button>
                <button class="social-btn facebook" id="shareFacebook"><i class="fab fa-facebook"></i> Facebook</button>
                <button class="social-btn youtube" id="shareYouTube"><i class="fab fa-youtube"></i> YouTube</button>
                <button class="social-btn tiktok" id="shareTikTok"><i class="fab fa-tiktok"></i> TikTok</button>
                <button class="social-btn twitter" id="shareTwitter"><i class="fab fa-twitter"></i> Twitter</button>
                <button class="social-btn kwai" id="shareKwai"><i class="fas fa-video"></i> Kwai</button>
                <button class="social-btn linkedin" id="shareLinkedIn"><i class="fab fa-linkedin"></i> LinkedIn</button>
                <button class="social-btn telegram" id="shareTelegram"><i class="fab fa-telegram-plane"></i> Telegram</button>
                <button class="social-btn messenger" id="shareMessenger"><i class="fab fa-facebook-messenger"></i> Messenger</button>
                <button class="social-btn prompt" id="promptBtn"><i class="fas fa-lightbulb"></i> Prompt</button>
                <button class="social-btn analytics" id="analyticsBtn"><i class="fas fa-chart-line"></i> Analytics</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="dashboard-header">
                <h2 class="dashboard-title">Dashboard Analytics</h2>
                <p class="dashboard-subtitle">Acompanhe o desempenho do seu chatbot em tempo real</p>
            </div>

            <div class="analytics-grid">
                <div class="analytics-card">
                    <div class="card-header">
                        <span class="card-title">Chatbots Ativos</span>
                        <div class="card-icon"><i class="fas fa-robot"></i></div>
                    </div>
                    <div class="card-value" id="activeChatbots">0</div>
                    <div class="card-change"><i class="fas fa-arrow-up"></i> <span id="createdToday">0</span> Criados hoje</div>
                </div>
                <div class="analytics-card">
                    <div class="card-header">
                        <span class="card-title">Conversas Hoje</span>
                        <div class="card-icon"><i class="fas fa-comments"></i></div>
                    </div>
                    <div class="card-value" id="conversationsToday">0</div>
                    <div class="card-change"><i class="fas fa-arrow-up"></i> <span id="messagesSent">0</span> Mensagens enviadas</div>
                </div>
                <div class="analytics-card">
                    <div class="card-header">
                        <span class="card-title">Leads Capturados</span>
                        <div class="card-icon"><i class="fas fa-user-check"></i></div>
                    </div>
                    <div class="card-value" id="totalLeads">0</div>
                    <div class="card-change"><i class="fas fa-arrow-up"></i> <span id="leadsToday">0</span> Hoje</div>
                </div>
                <div class="analytics-card">
                    <div class="card-header">
                        <span class="card-title">Taxa de Sucesso</span>
                        <div class="card-icon"><i class="fas fa-check-circle"></i></div>
                    </div>
                    <div class="card-value">100%</div>
                    <div class="card-change"><i class="fas fa-arrow-up"></i> Extração de dados</div>
                </div>
            </div>

            <div class="chat-preview">
                <div class="chat-header">
                    <span class="chat-title">Preview do Chatbot</span>
                </div>
                <iframe id="chatbotFrame" src="about:blank" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>

            <div class="widget-generator">
                <h3 class="widget-title"><i class="fas fa-code"></i> Gerador de Código do Widget</h3>
                <p class="panel-subtitle">Copie e cole este código em qualquer página para integrar seu chatbot.</p>
                <div class="code-block">
                    <button class="copy-btn" id="copyWidgetCodeBtn"><i class="fas fa-copy"></i> Copiar</button>
                    <pre><code id="widgetCodeDisplay">&lt;!-- LinkMágico Chatbot Widget --&gt;
&lt;script&gt;
    window.LinkMagicoWidgetConfig = {
        robotName: "Assistente IA",
        salesUrl: "",
        instructions: "",
        primaryColor: "#3b82f6"
    };
&lt;/script&gt;
&lt;script src="/public/widget.js"&gt;&lt;/script&gt;</code></pre>
                </div>
            </div>
        </div>
    </main>

    <div class="consent-modal" id="consentModal">
        <div class="consent-backdrop"></div>
        <div class="consent-content">
            <div class="consent-header">
                <h3>Preferências de Privacidade</h3>
                <button class="close-btn" id="closeConsentModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="consent-body">
                <div class="consent-warning">
                    <i class="fas fa-shield-alt"></i>
                    <p>Para continuar usando o LinkMágico, precisamos do seu consentimento para processar dados pessoais conforme a LGPD.</p>
                </div>
                <div class="consent-details">
                    <p>Usamos informações para:</p>
                    <ul>
                        <li>Personalizar respostas do chatbot</li>
                        <li>Melhorar métricas e analytics</li>
                        <li>Garantir segurança e prevenir fraudes</li>
                    </ul>
                    <div class="legal-basis">
                        Base legal: Consentimento do titular (Art. 7º, LGPD).
                    </div>
                </div>
                <div class="url-verification">
                    <label>
                        <input type="checkbox" id="urlResponsibilityCheckbox">
                        Confiro que a URL informada é de minha responsabilidade
                    </label>
                    <p class="robots-check">Recomendado: verifique robots.txt e políticas de página antes de extrair dados.</p>
                </div>
                <div class="consent-footer">
                    <button class="btn-secondary" id="rejectConsentBtn">Recusar</button>
                    <button class="btn-primary-consent" id="acceptConsentBtn" disabled>Aceitar e Continuar</button>
                </div>
                <div class="consent-links">
                    <a href="/privacy.html" target="_blank">Política de Privacidade</a>
                    <a href="/excluir-dados" target="_blank">Excluir meus dados</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}"></i><span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }

        const consentModal = document.getElementById('consentModal');
        const lgpdBadge = document.getElementById('lgpdBadge');
        const closeConsentModal = document.getElementById('closeConsentModal');
        const urlResponsibilityCheckbox = document.getElementById('urlResponsibilityCheckbox');
        const acceptConsentBtn = document.getElementById('acceptConsentBtn');
        const rejectConsentBtn = document.getElementById('rejectConsentBtn');

        lgpdBadge.addEventListener('click', () => {
            consentModal.style.display = 'flex';
        });

        closeConsentModal.addEventListener('click', () => {
            consentModal.style.display = 'none';
        });

        urlResponsibilityCheckbox.addEventListener('change', () => {
            acceptConsentBtn.disabled = !urlResponsibilityCheckbox.checked;
        });

        rejectConsentBtn.addEventListener('click', () => {
            showToast('Consentimento recusado. Algumas funcionalidades podem ser limitadas.', 'error');
            consentModal.style.display = 'none';
            // Implementar lógica para limitar funcionalidades ou redirecionar
        });

        acceptConsentBtn.addEventListener('click', () => {
            if (urlResponsibilityCheckbox.checked) {
                showToast('Consentimento aceito! Aproveite todas as funcionalidades.', 'success');
                consentModal.style.display = 'none';
                localStorage.setItem('lgpd_consent', 'accepted');
            } else {
                showToast('Por favor, confirme a responsabilidade da URL.', 'error');
            }
        });

        // Verificar consentimento ao carregar a página
        window.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('lgpd_consent')) {
                consentModal.style.display = 'flex';
            }
        });

        // ===== NOVA LÓGICA: GERAÇÃO DO LINK DO CHATBOT =====
        const robotNameInput = document.getElementById('robotName');
        const salesUrlInput = document.getElementById('salesUrl');
        const customInstructionsInput = document.getElementById('customInstructions');
        const activateChatbotBtn = document.getElementById('activateChatbotBtn');
        const chatbotFrame = document.getElementById('chatbotFrame');
        const successAlert = document.getElementById('successAlert');
        const widgetCodeDisplay = document.getElementById('widgetCodeDisplay');
        const copyWidgetCodeBtn = document.getElementById('copyWidgetCodeBtn');
        
        // Novos elementos
        const chatbotLinkSection = document.getElementById('chatbotLinkSection');
        const chatbotLinkUrl = document.getElementById('chatbotLinkUrl');
        const copyChatbotLinkBtn = document.getElementById('copyChatbotLinkBtn');
        const extractedDataContent = document.getElementById('extractedDataContent');
        const extractedSummary = document.getElementById('extractedSummary');

        // Botões de compartilhamento social
        const shareWhatsApp = document.getElementById('shareWhatsApp');
        const shareInstagram = document.getElementById('shareInstagram');
        const shareFacebook = document.getElementById('shareFacebook');
        const shareYouTube = document.getElementById('shareYouTube');
        const shareTikTok = document.getElementById('shareTikTok');
        const shareTwitter = document.getElementById('shareTwitter');
        const shareKwai = document.getElementById('shareKwai');
        const shareLinkedIn = document.getElementById('shareLinkedIn');
        const shareTelegram = document.getElementById('shareTelegram');
        const shareMessenger = document.getElementById('shareMessenger');

        let currentChatbotUrl = '';

        function showLoading() {
            activateChatbotBtn.disabled = true;
            activateChatbotBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ativando...';
        }

        function hideLoading() {
            activateChatbotBtn.disabled = false;
            activateChatbotBtn.innerHTML = '<i class="fas fa-play-circle"></i> Ativar Chatbot Inteligente';
        }

        function generateChatbotUrl(robotName, salesUrl, instructions) {
            const params = new URLSearchParams({
                name: robotName,
                url: salesUrl,
                instructions: instructions
            });
            return `${window.location.origin}/chatbot?${params.toString()}`;
        }

        function updateSocialShareLinks(chatbotUrl, robotName) {
            const shareText = `Converse com ${robotName} - Assistente IA inteligente para vendas`;
            const encodedUrl = encodeURIComponent(chatbotUrl);
            const encodedText = encodeURIComponent(shareText);
            
            // WhatsApp
            shareWhatsApp.onclick = () => {
                window.open(`https://wa.me/?text=${encodedText}%20${encodedUrl}`, '_blank');
            };
            
            // Instagram (simplificado - abre em nova aba)
            shareInstagram.onclick = () => {
                window.open('https://www.instagram.com/', '_blank');
            };
            
            // Facebook
            shareFacebook.onclick = () => {
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodedText}`, '_blank');
            };
            
            // YouTube (simplificado)
            shareYouTube.onclick = () => {
                window.open('https://www.youtube.com/', '_blank');
            };
            
            // TikTok (simplificado)
            shareTikTok.onclick = () => {
                window.open('https://www.tiktok.com/', '_blank');
            };
            
            // Twitter
            shareTwitter.onclick = () => {
                window.open(`https://twitter.com/intent/tweet?text=${encodedText}&url=${encodedUrl}`, '_blank');
            };
            
            // Kwai (simplificado)
            shareKwai.onclick = () => {
                window.open('https://www.kwai.com/', '_blank');
            };
            
            // LinkedIn
            shareLinkedIn.onclick = () => {
                window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`, '_blank');
            };
            
            // Telegram
            shareTelegram.onclick = () => {
                window.open(`https://t.me/share/url?url=${encodedUrl}&text=${encodedText}`, '_blank');
            };
            
            // Messenger (simplificado)
            shareMessenger.onclick = () => {
                window.open(`https://www.facebook.com/dialog/send?link=${encodedUrl}&app_id=YOUR_APP_ID&redirect_uri=${encodedUrl}`, '_blank');
            };
        }

        activateChatbotBtn.addEventListener('click', async () => {
            const robotName = robotNameInput.value;
            const salesUrl = salesUrlInput.value;
            const customInstructions = customInstructionsInput.value;

            if (!robotName || !salesUrl) {
                showToast('Por favor, preencha o nome do assistente e a URL da página.', 'error');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/api/extract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: salesUrl, instructions: customInstructions, robotName: robotName })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Erro desconhecido na extração.');
                }

                // Gerar URL do chatbot
                currentChatbotUrl = generateChatbotUrl(robotName, salesUrl, customInstructions);
                
                // Atualizar seção do link do chatbot
                chatbotLinkUrl.href = currentChatbotUrl;
                chatbotLinkUrl.textContent = currentChatbotUrl;
                
                // Atualizar dados extraídos
                if (data.data && data.data.summary) {
                    extractedSummary.textContent = data.data.summary;
                } else {
                    extractedSummary.textContent = 'Dados extraídos com sucesso da página.';
                }
                
                // Mostrar seção do link do chatbot
                chatbotLinkSection.classList.add('active');

                // Atualizar links de compartilhamento social
                updateSocialShareLinks(currentChatbotUrl, robotName);

                // Atualiza o iframe do chatbot preview
                const chatbotParams = new URLSearchParams({
                    url: salesUrl,
                    name: robotName,
                    instructions: customInstructions
                });
                chatbotFrame.src = `/chat.html?${chatbotParams.toString()}`;

                // Atualiza o código do widget
                // SOLUÇÃO DEFINITIVA: Recuperar a API Key real da sessão
                const serverUrl = 'https://linkmagico-comercial.onrender.com';
                
                // Fazer requisição ao servidor para obter a API Key da sessão
                const apiKeyResponse = await fetch('/api/get-api-key');
                const apiKeyData = await apiKeyResponse.json();
                const apiKeyToUse = (apiKeyData.success && apiKeyData.apiKey) ? apiKeyData.apiKey : 'SEU_API_KEY';
                
                widgetCodeDisplay.innerHTML = `&lt;!-- LinkMágico Chatbot Widget v7.0 --&gt;<br>&lt;script&gt;<br>    window.LinkMagicoWidgetConfig = {<br>        robotName: &quot;${robotName}&quot;,<br>        salesUrl: &quot;${salesUrl}&quot;,<br>        instructions: &quot;${customInstructions}&quot;,<br>        primaryColor: &quot;#3b82f6&quot;<br>    };<br>&lt;/script&gt;<br>&lt;script src=&quot;${serverUrl}/public/widget-loader.js?apiKey=${apiKeyToUse}&quot; async&gt;&lt;/script&gt;`;

                successAlert.style.display = 'block';
                showToast('Chatbot ativado com sucesso! Link gerado e pronto para compartilhar.', 'success');

                // Atualizar analytics
                document.getElementById('activeChatbots').textContent = '1';
                document.getElementById('createdToday').textContent = '1';
                
                // Carregar dados de leads
                loadDashboardLeads();

            } catch (error) {
                console.error('Erro ao ativar chatbot:', error);
                showToast(`Erro ao ativar chatbot: ${error.message || 'Servidor indisponível. Tente novamente em alguns minutos.'}`, 'error');
            } finally {
                hideLoading();
            }
        });

        // Copiar link do chatbot
        copyChatbotLinkBtn.addEventListener('click', () => {
            if (currentChatbotUrl) {
                navigator.clipboard.writeText(currentChatbotUrl).then(() => {
                    showToast('Link do chatbot copiado!', 'success');
                }).catch(err => {
                    console.error('Erro ao copiar link:', err);
                    showToast('Erro ao copiar link.', 'error');
                });
            } else {
                showToast('Nenhum link de chatbot disponível para copiar.', 'error');
            }
        });

        copyWidgetCodeBtn.addEventListener('click', () => {
            const codeToCopy = widgetCodeDisplay.textContent;
            navigator.clipboard.writeText(codeToCopy).then(() => {
                showToast('Código do widget copiado!', 'success');
            }).catch(err => {
                console.error('Erro ao copiar código:', err);
                showToast('Erro ao copiar código.', 'error');
            });
        });

        // Botões de funcionalidades adicionais
        document.getElementById('promptBtn').addEventListener('click', () => {
            showToast('Funcionalidade Prompt em desenvolvimento', 'info');
        });

        document.getElementById('analyticsBtn').addEventListener('click', () => {
            showToast('Funcionalidade Analytics em desenvolvimento', 'info');
        });

    </script>

    
    <!-- ===== NOVOS SISTEMAS - LINK MÁGICO V2.0 ===== -->
    <div id="newSystemsPanel" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; overflow-y:auto;">
        <div style="max-width:1400px; margin:2rem auto; padding:2rem;">
            <button onclick="closeNewSystems()" style="position:fixed; top:20px; right:20px; background:#ef4444; color:white; border:none; padding:1rem 1.5rem; border-radius:12px; cursor:pointer; font-weight:600; z-index:10000;">
                <i class="fas fa-times"></i> Fechar
            </button>
            
            <h1 style="color:#60a5fa; font-size:2rem; margin-bottom:2rem; text-align:center;">
                🚀 Sistemas Avançados - Link Mágico V2.0
            </h1>
            
            <!-- Tabs -->
            <div class="new-tabs" style="display:flex; gap:1rem; margin-bottom:2rem; flex-wrap:wrap; justify-content:center;">
                <button class="new-tab active" onclick="showNewTab('analytics')" style="background:#3b82f6; color:white; border:none; padding:1rem 1.5rem; border-radius:12px; cursor:pointer; font-weight:600;">
                    📊 Analytics
                </button>
                <button class="new-tab" onclick="showNewTab('webhooks')" style="background:#334155; color:white; border:none; padding:1rem 1.5rem; border-radius:12px; cursor:pointer; font-weight:600;">
                    🔗 Webhooks
                </button>
                <button class="new-tab" onclick="showNewTab('knowledge')" style="background:#334155; color:white; border:none; padding:1rem 1.5rem; border-radius:12px; cursor:pointer; font-weight:600;">
                    📚 Knowledge Base
                </button>
                <button class="new-tab" onclick="showNewTab('billing')" style="background:#334155; color:white; border:none; padding:1rem 1.5rem; border-radius:12px; cursor:pointer; font-weight:600;">
                    💳 Billing
                </button>
                <button class="new-tab" onclick="showNewTab('llm')" style="background:#334155; color:white; border:none; padding:1rem 1.5rem; border-radius:12px; cursor:pointer; font-weight:600;">
                    🎯 Otimização LLM
                </button>
                <button class="new-tab" onclick="showNewTab('system')" style="background:#334155; color:white; border:none; padding:1rem 1.5rem; border-radius:12px; cursor:pointer; font-weight:600;">
                    ⚙️ Sistema
                </button>
                <button class="new-tab" onclick="showNewTab('gmail')" style="background:#334155; color:white; border:none; padding:1rem 1.5rem; border-radius:12px; cursor:pointer; font-weight:600;">
                    📧 Gmail
                </button>
                <button class="new-tab" onclick="showNewTab('whatsapp')" style="background:#334155; color:white; border:none; padding:1rem 1.5rem; border-radius:12px; cursor:pointer; font-weight:600;">
                    📱 WhatsApp
                </button>
                <button class="new-tab" onclick="showNewTab('chatgpt')" style="background:#334155; color:white; border:none; padding:1rem 1.5rem; border-radius:12px; cursor:pointer; font-weight:600;">
                    🤖 ChatGPT
                </button>
                <button class="new-tab" onclick="showNewTab('whitelabel')" style="background:#334155; color:white; border:none; padding:1rem 1.5rem; border-radius:12px; cursor:pointer; font-weight:600;">
                    🎨 Whitelabel
                </button>
                <button class="new-tab" onclick="showNewTab('leads')" style="background:#334155; color:white; border:none; padding:1rem 1.5rem; border-radius:12px; cursor:pointer; font-weight:600;">
                    📝 Leads
                </button>
            </div>
            
            <!-- Tab Contents -->
            <div id="tab-analytics" class="new-tab-content" style="display:block;">
                <div style="background:#1e293b; padding:2rem; border-radius:16px; margin-bottom:1rem;">
                    <h2 style="color:#60a5fa; margin-bottom:1rem;">📊 Analytics Profissional</h2>
                    <p style="color:#cbd5e1; margin-bottom:1.5rem;">Visualize métricas detalhadas do seu chatbot</p>
                    
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1rem; margin-bottom:2rem;">
                        <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">Total de Mensagens</div>
                            <div id="analytics-messages" style="color:#60a5fa; font-size:2rem; font-weight:700;">-</div>
                        </div>
                        <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">Conversas</div>
                            <div id="analytics-conversations" style="color:#10b981; font-size:2rem; font-weight:700;">-</div>
                        </div>
                        <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">Leads Capturados</div>
                            <div id="analytics-leads" style="color:#f59e0b; font-size:2rem; font-weight:700;">-</div>
                        </div>
                        <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">Taxa de Sucesso</div>
                            <div id="analytics-success" style="color:#06d6a0; font-size:2rem; font-weight:700;">-</div>
                        </div>
                    </div>
                    
                    <button onclick="loadAnalytics()" style="background:#3b82f6; color:white; border:none; padding:1rem 2rem; border-radius:12px; cursor:pointer; font-weight:600; width:100%;">
                        🔄 Atualizar Analytics
                    </button>
                </div>
            </div>
            
            <div id="tab-webhooks" class="new-tab-content" style="display:none;">
                <div style="background:#1e293b; padding:2rem; border-radius:16px;">
                    <h2 style="color:#60a5fa; margin-bottom:1rem;">🔗 Webhooks</h2>
                    <p style="color:#cbd5e1; margin-bottom:1.5rem;">Configure webhooks para integrar com sistemas externos</p>
                    
                    <div id="webhooks-list" style="margin-bottom:2rem;">
                        <p style="color:#94a3b8;">Carregando webhooks...</p>
                    </div>
                    
                    <button onclick="showAddWebhook()" style="background:#10b981; color:white; border:none; padding:1rem 2rem; border-radius:12px; cursor:pointer; font-weight:600; width:100%;">
                        ➕ Adicionar Webhook
                    </button>
                </div>
            </div>
            
            <div id="tab-knowledge" class="new-tab-content" style="display:none;">
                <div style="background:#1e293b; padding:2rem; border-radius:16px;">
                    <h2 style="color:#60a5fa; margin-bottom:1rem;">📚 Knowledge Base</h2>
                    <p style="color:#cbd5e1; margin-bottom:1.5rem;">Gerencie FAQs e documentos do seu chatbot</p>
                    
                    <div style="margin-bottom:2rem;">
                        <label style="color:#cbd5e1; display:block; margin-bottom:0.5rem; font-weight:600;">Pergunta:</label>
                        <input id="faq-question" type="text" placeholder="Ex: Qual o horário de funcionamento?" style="width:100%; padding:1rem; border:2px solid #475569; border-radius:12px; background:#334155; color:#f8fafc; margin-bottom:1rem;">
                        
                        <label style="color:#cbd5e1; display:block; margin-bottom:0.5rem; font-weight:600;">Resposta:</label>
                        <textarea id="faq-answer" placeholder="Ex: Funcionamos de segunda a sexta, das 9h às 18h" style="width:100%; padding:1rem; border:2px solid #475569; border-radius:12px; background:#334155; color:#f8fafc; min-height:100px; margin-bottom:1rem;"></textarea>
                        
                        <button onclick="addFAQ()" style="background:#10b981; color:white; border:none; padding:1rem 2rem; border-radius:12px; cursor:pointer; font-weight:600; width:100%;">
                            ➕ Adicionar FAQ
                        </button>
                    </div>
                    
                    <div id="faqs-list" style="margin-top:2rem;">
                        <h3 style="color:#cbd5e1; margin-bottom:1rem;">FAQs Cadastradas:</h3>
                        <div id="faqs-container" style="color:#94a3b8;">
                            Nenhuma FAQ cadastrada ainda.
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="tab-billing" class="new-tab-content" style="display:none;">
                <div style="background:#1e293b; padding:2rem; border-radius:16px;">
                    <h2 style="color:#60a5fa; margin-bottom:1rem;">💳 Planos e Billing</h2>
                    <p style="color:#cbd5e1; margin-bottom:1.5rem;">Gerencie planos e assinaturas</p>
                    
                    <div id="plans-container" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1.5rem;">
                        <p style="color:#94a3b8;">Carregando planos...</p>
                    </div>
                </div>
            </div>
            
            <div id="tab-llm" class="new-tab-content" style="display:none;">
                <div style="background:#1e293b; padding:2rem; border-radius:16px;">
                    <h2 style="color:#60a5fa; margin-bottom:1rem;">🎯 Otimização LLM</h2>
                    <p style="color:#cbd5e1; margin-bottom:1.5rem;">Economize até 60% nos custos de IA</p>
                    
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem;">
                        <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">Cache Hits</div>
                            <div id="llm-cache-hits" style="color:#10b981; font-size:2rem; font-weight:700;">-</div>
                        </div>
                        <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">Economia</div>
                            <div id="llm-savings" style="color:#06d6a0; font-size:2rem; font-weight:700;">-</div>
                        </div>
                        <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">Taxa de Cache</div>
                            <div id="llm-cache-rate" style="color:#f59e0b; font-size:2rem; font-weight:700;">-</div>
                        </div>
                    </div>
                    
                    <button onclick="loadLLMStats()" style="background:#3b82f6; color:white; border:none; padding:1rem 2rem; border-radius:12px; cursor:pointer; font-weight:600; width:100%; margin-top:2rem;">
                        🔄 Atualizar Estatísticas
                    </button>
                </div>
            </div>
            
            <div id="tab-system" class="new-tab-content" style="display:none;">
                <div style="background:#1e293b; padding:2rem; border-radius:16px;">
                    <h2 style="color:#60a5fa; margin-bottom:1rem;">⚙️ Status do Sistema</h2>
                    <div id="system-status" style="color:#cbd5e1;">
                        <p>Carregando status...</p>
                    </div>
                    
                    <button onclick="loadSystemStatus()" style="background:#3b82f6; color:white; border:none; padding:1rem 2rem; border-radius:12px; cursor:pointer; font-weight:600; width:100%; margin-top:2rem;">
                        🔄 Atualizar Status
                    </button>
                </div>
            </div>
            
            <!-- Tab Gmail -->
            <div id="tab-gmail" class="new-tab-content" style="display:none;">
                <div style="background:#1e293b; padding:2rem; border-radius:16px;">
                    <h2 style="color:#60a5fa; margin-bottom:1rem;">📧 Integração Gmail</h2>
                    <p style="color:#cbd5e1; margin-bottom:1.5rem;">Configure envio automático de emails</p>
                    
                    <div style="background:#334155; padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
                        <h3 style="color:#cbd5e1; margin-bottom:1rem;">Status da Integração</h3>
                        <div id="gmail-status" style="color:#94a3b8;">Carregando...</div>
                    </div>
                    
                    <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                        <h3 style="color:#cbd5e1; margin-bottom:1rem;">Testar Envio</h3>
                        <input type="email" id="test-email" placeholder="email@exemplo.com" style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #475569; background:#1e293b; color:#cbd5e1; margin-bottom:1rem;">
                        <button onclick="testGmail()" style="background:#3b82f6; color:white; border:none; padding:0.75rem 1.5rem; border-radius:8px; cursor:pointer; font-weight:600;">
                            Enviar Email de Teste
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab WhatsApp -->
            <div id="tab-whatsapp" class="new-tab-content" style="display:none;">
                <div style="background:#1e293b; padding:2rem; border-radius:16px;">
                    <h2 style="color:#60a5fa; margin-bottom:1rem;">📱 Integração WhatsApp</h2>
                    <p style="color:#cbd5e1; margin-bottom:1.5rem;">Configure notificações via WhatsApp</p>
                    
                    <div style="background:#334155; padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
                        <h3 style="color:#cbd5e1; margin-bottom:1rem;">Status da Integração</h3>
                        <div id="whatsapp-status" style="color:#94a3b8;">Carregando...</div>
                    </div>
                    
                    <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                        <h3 style="color:#cbd5e1; margin-bottom:1rem;">Testar Envio</h3>
                        <input type="tel" id="test-phone" placeholder="+5511999999999" style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #475569; background:#1e293b; color:#cbd5e1; margin-bottom:1rem;">
                        <button onclick="testWhatsApp()" style="background:#25d366; color:white; border:none; padding:0.75rem 1.5rem; border-radius:8px; cursor:pointer; font-weight:600;">
                            Enviar Mensagem de Teste
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab ChatGPT -->
            <div id="tab-chatgpt" class="new-tab-content" style="display:none;">
                <div style="background:#1e293b; padding:2rem; border-radius:16px;">
                    <h2 style="color:#60a5fa; margin-bottom:1rem;">🤖 Integração ChatGPT</h2>
                    <p style="color:#cbd5e1; margin-bottom:1.5rem;">Use GPT-4 para respostas de alta qualidade</p>
                    
                    <div style="background:#334155; padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
                        <h3 style="color:#cbd5e1; margin-bottom:1rem;">Status da Integração</h3>
                        <div id="chatgpt-status" style="color:#94a3b8;">Carregando...</div>
                    </div>
                    
                    <div style="background:#334155; padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
                        <h3 style="color:#cbd5e1; margin-bottom:1rem;">Modelos Disponíveis</h3>
                        <div id="chatgpt-models" style="color:#94a3b8;">Carregando...</div>
                    </div>
                    
                    <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                        <h3 style="color:#cbd5e1; margin-bottom:1rem;">Testar Geração</h3>
                        <textarea id="test-prompt" placeholder="Digite uma pergunta..." style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #475569; background:#1e293b; color:#cbd5e1; margin-bottom:1rem; min-height:100px;"></textarea>
                        <button onclick="testChatGPT()" style="background:#10a37f; color:white; border:none; padding:0.75rem 1.5rem; border-radius:8px; cursor:pointer; font-weight:600;">
                            Gerar Resposta
                        </button>
                        <div id="chatgpt-response" style="margin-top:1rem; padding:1rem; background:#1e293b; border-radius:8px; color:#cbd5e1; display:none;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Whitelabel -->
            <div id="tab-whitelabel" class="new-tab-content" style="display:none;">
                <div style="background:#1e293b; padding:2rem; border-radius:16px;">
                    <h2 style="color:#60a5fa; margin-bottom:1rem;">🎨 Whitelabel</h2>
                    <p style="color:#cbd5e1; margin-bottom:1.5rem;">Personalize a marca do seu chatbot</p>
                    
                    <div style="background:#334155; padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
                        <h3 style="color:#cbd5e1; margin-bottom:1rem;">Configuração</h3>
                        
                        <label style="color:#94a3b8; display:block; margin-bottom:0.5rem;">Nome da Empresa:</label>
                        <input type="text" id="wl-company" placeholder="Minha Empresa" style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #475569; background:#1e293b; color:#cbd5e1; margin-bottom:1rem;">
                        
                        <label style="color:#94a3b8; display:block; margin-bottom:0.5rem;">URL do Logo:</label>
                        <input type="url" id="wl-logo" placeholder="https://exemplo.com/logo.png" style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #475569; background:#1e293b; color:#cbd5e1; margin-bottom:1rem;">
                        
                        <label style="color:#94a3b8; display:block; margin-bottom:0.5rem;">Cor Primária:</label>
                        <input type="color" id="wl-primary" value="#3b82f6" style="width:100%; padding:0.5rem; border-radius:8px; border:1px solid #475569; background:#1e293b; margin-bottom:1rem;">
                        
                        <label style="color:#94a3b8; display:block; margin-bottom:0.5rem;">Cor Secundária:</label>
                        <input type="color" id="wl-secondary" value="#8b5cf6" style="width:100%; padding:0.5rem; border-radius:8px; border:1px solid #475569; background:#1e293b; margin-bottom:1.5rem;">
                        
                        <button onclick="saveWhitelabel()" style="background:#3b82f6; color:white; border:none; padding:0.75rem 1.5rem; border-radius:8px; cursor:pointer; font-weight:600; width:100%;">
                            Salvar Configuração
                        </button>
                    </div>
                    
                    <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                        <h3 style="color:#cbd5e1; margin-bottom:1rem;">Preview</h3>
                        <div id="wl-preview" style="padding:2rem; background:#1e293b; border-radius:8px; text-align:center;">
                            <div style="color:#94a3b8;">Configure os campos acima para ver o preview</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Leads -->
            <div id="tab-leads" class="new-tab-content" style="display:none;">
                <div style="background:#1e293b; padding:2rem; border-radius:16px;">
                    <h2 style="color:#60a5fa; margin-bottom:1rem;">📝 Leads Estruturados</h2>
                    <p style="color:#cbd5e1; margin-bottom:1.5rem;">Gerencie leads capturados com campos estruturados</p>
                    
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-bottom:2rem;">
                        <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">Total de Leads</div>
                            <div id="leads-total" style="color:#60a5fa; font-size:2rem; font-weight:700;">-</div>
                        </div>
                        <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">Leads Hot</div>
                            <div id="leads-hot" style="color:#ef4444; font-size:2rem; font-weight:700;">-</div>
                        </div>
                        <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">Leads Warm</div>
                            <div id="leads-warm" style="color:#f59e0b; font-size:2rem; font-weight:700;">-</div>
                        </div>
                        <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">Leads Cold</div>
                            <div id="leads-cold" style="color:#3b82f6; font-size:2rem; font-weight:700;">-</div>
                        </div>
                    </div>
                    
                    <div style="background:#334155; padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                            <h3 style="color:#cbd5e1; margin:0;">Lista de Leads</h3>
                            <button onclick="exportLeads()" style="background:#10b981; color:white; border:none; padding:0.5rem 1rem; border-radius:8px; cursor:pointer; font-weight:600;">
                                📥 Exportar CSV
                            </button>
                        </div>
                        <div id="leads-list" style="color:#94a3b8;">Carregando...</div>
                    </div>
                    
                    <!-- Seção de Backup -->
                    <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                        <h3 style="color:#cbd5e1; margin-bottom:1rem;">🔐 Backup de Leads</h3>
                        <p style="color:#94a3b8; font-size:0.9rem; margin-bottom:1rem;">Backups automáticos diários + backup manual sob demanda</p>
                        
                        <div style="display:flex; gap:1rem; margin-bottom:1.5rem;">
                            <button onclick="createBackup()" style="background:#3b82f6; color:white; border:none; padding:0.75rem 1.5rem; border-radius:8px; cursor:pointer; font-weight:600; flex:1;">
                                💾 Criar Backup Agora
                            </button>
                            <button onclick="loadBackups()" style="background:#8b5cf6; color:white; border:none; padding:0.75rem 1.5rem; border-radius:8px; cursor:pointer; font-weight:600; flex:1;">
                                🔄 Atualizar Lista
                            </button>
                        </div>
                        
                        <div id="backups-list" style="max-height:300px; overflow-y:auto;">
                            <p style="color:#94a3b8;">Carregando backups...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Botão para abrir novos sistemas -->
    <button id="openNewSystemsBtn" onclick="openNewSystems()" style="position:fixed; bottom:20px; right:20px; background:linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); color:white; border:none; padding:1rem 1.5rem; border-radius:12px; cursor:pointer; font-weight:600; box-shadow:0 10px 25px rgba(59,130,246,0.4); z-index:1000; display:flex; align-items:center; gap:0.5rem; animation:pulse 2s infinite;">
        <i class="fas fa-rocket"></i> Novos Sistemas V2.0
    </button>
    
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .new-tab.active {
            background: #3b82f6 !important;
        }
        
        .new-tab:hover {
            opacity: 0.8;
        }
    </style>
    
    <script>
        // Funções para os novos sistemas
        function openNewSystems() {
            document.getElementById('newSystemsPanel').style.display = 'block';
            loadSystemStatus();
        }
        
        function closeNewSystems() {
            document.getElementById('newSystemsPanel').style.display = 'none';
        }
        
        function showNewTab(tabName) {
            // Esconder todos os conteúdos
            document.querySelectorAll('.new-tab-content').forEach(el => el.style.display = 'none');
            
            // Remover active de todas as tabs
            document.querySelectorAll('.new-tab').forEach(el => el.classList.remove('active'));
            
            // Mostrar conteúdo selecionado
            document.getElementById('tab-' + tabName).style.display = 'block';
            
            // Ativar tab
            event.target.classList.add('active');
            
            // Carregar dados da tab
            if (tabName === 'analytics') loadAnalytics();
            if (tabName === 'webhooks') loadWebhooks();
            if (tabName === 'billing') loadPlans();
            if (tabName === 'llm') loadLLMStats();
            if (tabName === 'system') loadSystemStatus();
            if (tabName === 'gmail') loadGmailStatus();
            if (tabName === 'whatsapp') loadWhatsAppStatus();
            if (tabName === 'chatgpt') loadChatGPTStatus();
            if (tabName === 'leads') {
                loadLeadsStats();
                loadBackups(); // Carregar backups também
            }
        }
        
        async function loadAnalytics() {
            try {
                // Buscar dados de leads
                const leadsResponse = await fetch('/admin/leads', {
                    headers: {
                        'X-API-Key': 'linkmagico-api-key-2024'
                    }
                });
                const leadsData = await leadsResponse.json();
                
                if (leadsData.success && leadsData.leads) {
                    const leads = leadsData.leads;
                    const totalLeads = leads.length;
                    
                    // Calcular total de mensagens (soma de todas as conversas)
                    let totalMessages = 0;
                    let totalConversations = 0;
                    
                    leads.forEach(lead => {
                        if (lead.conversations && Array.isArray(lead.conversations)) {
                            totalConversations += lead.conversations.length;
                            lead.conversations.forEach(conv => {
                                if (conv.messages && Array.isArray(conv.messages)) {
                                    totalMessages += conv.messages.length;
                                }
                            });
                        }
                    });
                    
                    // Calcular taxa de sucesso (leads com email ou telefone / total)
                    const leadsWithContact = leads.filter(lead => {
                        const telefone = lead.telefone || lead.phone;
                        return lead.email || telefone;
                    }).length;
                    
                    const successRate = totalLeads > 0 ? Math.round((leadsWithContact / totalLeads) * 100) : 100;
                    
                    // Atualizar interface
                    document.getElementById('analytics-messages').textContent = totalMessages;
                    document.getElementById('analytics-conversations').textContent = totalConversations;
                    document.getElementById('analytics-leads').textContent = totalLeads;
                    document.getElementById('analytics-success').textContent = successRate + '%';
                    
                    console.log(`📊 Analytics carregado: ${totalMessages} mensagens, ${totalConversations} conversas, ${totalLeads} leads, ${successRate}% sucesso`);
                } else {
                    // Se não houver dados, mostrar zeros
                    document.getElementById('analytics-messages').textContent = '0';
                    document.getElementById('analytics-conversations').textContent = '0';
                    document.getElementById('analytics-leads').textContent = '0';
                    document.getElementById('analytics-success').textContent = '100%';
                }
            } catch (error) {
                console.error('Erro ao carregar analytics:', error);
                // Mostrar zeros em caso de erro
                document.getElementById('analytics-messages').textContent = '0';
                document.getElementById('analytics-conversations').textContent = '0';
                document.getElementById('analytics-leads').textContent = '0';
                document.getElementById('analytics-success').textContent = '0%';
            }
        }
        
        async function loadWebhooks() {
            try {
                const response = await fetch('/api/webhooks/default');
                const data = await response.json();
                
                const container = document.getElementById('webhooks-list');
                if (data.success && data.webhooks.length > 0) {
                    container.innerHTML = data.webhooks.map(w => `
                        <div style="background:#334155; padding:1rem; border-radius:12px; margin-bottom:1rem;">
                            <div style="color:#cbd5e1; font-weight:600;">${w.eventType}</div>
                            <div style="color:#94a3b8; font-size:0.9rem;">${w.url}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color:#94a3b8;">Nenhum webhook configurado.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar webhooks:', error);
            }
        }
        
        async function addFAQ() {
            const question = document.getElementById('faq-question').value;
            const answer = document.getElementById('faq-answer').value;
            
            if (!question || !answer) {
                alert('Preencha pergunta e resposta!');
                return;
            }
            
            try {
                const response = await fetch('/api/knowledge/default/faq', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({question, answer})
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('FAQ adicionada com sucesso!');
                    document.getElementById('faq-question').value = '';
                    document.getElementById('faq-answer').value = '';
                    loadFAQs();
                }
            } catch (error) {
                console.error('Erro ao adicionar FAQ:', error);
                alert('Erro ao adicionar FAQ');
            }
        }
        
        async function loadFAQs() {
            try {
                const response = await fetch('/api/knowledge/default');
                const data = await response.json();
                
                const container = document.getElementById('faqs-container');
                if (data.success && data.knowledge.faqs && data.knowledge.faqs.length > 0) {
                    container.innerHTML = data.knowledge.faqs.map(faq => `
                        <div style="background:#334155; padding:1rem; border-radius:12px; margin-bottom:1rem;">
                            <div style="color:#cbd5e1; font-weight:600; margin-bottom:0.5rem;">❓ ${faq.question}</div>
                            <div style="color:#94a3b8; font-size:0.9rem;">💬 ${faq.answer}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color:#94a3b8;">Nenhuma FAQ cadastrada ainda.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar FAQs:', error);
            }
        }
        
        async function loadPlans() {
            try {
                const response = await fetch('/api/plans');
                const data = await response.json();
                
                const container = document.getElementById('plans-container');
                if (data.success) {
                    container.innerHTML = data.plans.map(plan => `
                        <div style="background:#334155; padding:1.5rem; border-radius:12px; border:2px solid ${plan.id === 'professional' ? '#3b82f6' : '#475569'};">
                            <h3 style="color:#cbd5e1; margin-bottom:0.5rem;">${plan.name}</h3>
                            <div style="color:#60a5fa; font-size:2rem; font-weight:700; margin-bottom:1rem;">
                                ${plan.price === 0 ? 'Grátis' : 'R$ ' + plan.price.toFixed(2)}
                            </div>
                            <ul style="color:#94a3b8; font-size:0.9rem; list-style:none; padding:0;">
                                <li style="margin-bottom:0.5rem;">✓ ${plan.features.maxChatbots} chatbots</li>
                                <li style="margin-bottom:0.5rem;">✓ ${plan.features.requestsPerMinute} req/min</li>
                                <li style="margin-bottom:0.5rem;">✓ ${plan.features.requestsPerHour} req/hora</li>
                            </ul>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar planos:', error);
            }
        }
        
        async function loadLLMStats() {
            try {
                const response = await fetch('/api/llm/stats/default?days=30');
                const data = await response.json();
                
                if (data.success && data.savings) {
                    document.getElementById('llm-cache-hits').textContent = data.savings.cacheHits || 0;
                    document.getElementById('llm-savings').textContent = 'R$ ' + (data.savings.savings || 0);
                    document.getElementById('llm-cache-rate').textContent = (data.savings.cacheHitRate || 0) + '%';
                }
            } catch (error) {
                console.error('Erro ao carregar stats LLM:', error);
            }
        }
        
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();
                
                const container = document.getElementById('system-status');
                if (data.success) {
                    container.innerHTML = `
                        <div style="display:grid; gap:1rem;">
                            <div style="background:#334155; padding:1rem; border-radius:12px;">
                                <div style="color:#94a3b8;">Servidor:</div>
                                <div style="color:#10b981; font-weight:600;">${data.status.server}</div>
                            </div>
                            <div style="background:#334155; padding:1rem; border-radius:12px;">
                                <div style="color:#94a3b8;">Banco de Dados:</div>
                                <div style="color:#10b981; font-weight:600;">${data.status.database.type} - ${data.status.database.connected ? 'Conectado' : 'Desconectado'}</div>
                            </div>
                            <div style="background:#334155; padding:1rem; border-radius:12px;">
                                <div style="color:#94a3b8;">Cache:</div>
                                <div style="color:#10b981; font-weight:600;">${data.status.cache.type} - ${data.status.cache.connected ? 'Conectado' : 'Desconectado'}</div>
                            </div>
                            <div style="background:#334155; padding:1rem; border-radius:12px;">
                                <div style="color:#94a3b8;">Uptime:</div>
                                <div style="color:#60a5fa; font-weight:600;">${Math.floor(data.status.uptime / 60)} minutos</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar status:', error);
                document.getElementById('system-status').innerHTML = '<p style="color:#ef4444;">Erro ao carregar status do sistema</p>';
            }
        }
        
        function showAddWebhook() {
            alert('Funcionalidade de adicionar webhook em desenvolvimento. Use a API diretamente por enquanto.');
        }
        
        // Carregar FAQs ao abrir a tab
        setTimeout(() => {
            if (document.getElementById('tab-knowledge').style.display === 'block') {
                loadFAQs();
            }
        }, 1000);
    
        
        // ===== FUNÇÕES DAS NOVAS INTEGRAÇÕES V3 =====
        
        async function loadGmailStatus() {
            try {
                const response = await fetch('/api/gmail/status');
                const data = await response.json();
                const statusEl = document.getElementById('gmail-status');
                
                if (data.configured) {
                    statusEl.innerHTML = '<div style="color:#10b981;">✅ Gmail configurado e pronto para uso</div>';
                } else {
                    statusEl.innerHTML = '<div style="color:#f59e0b;">⚠️ Gmail não configurado. Configure as variáveis GMAIL_USER e GMAIL_PASSWORD no .env</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar status Gmail:', error);
            }
        }
        
        async function testGmail() {
            const email = document.getElementById('test-email').value;
            if (!email) {
                alert('Digite um email!');
                return;
            }
            
            try {
                const response = await fetch('/api/gmail/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        to: email,
                        subject: 'Teste Link Mágico V3',
                        html: '<h1>Email de teste!</h1><p>Se você recebeu este email, a integração Gmail está funcionando! 🎉</p>'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Email enviado com sucesso! Verifique a caixa de entrada.');
                } else {
                    alert('Erro ao enviar email: ' + (data.error || 'Desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao enviar email');
            }
        }
        
        async function loadWhatsAppStatus() {
            try {
                const response = await fetch('/api/whatsapp/status');
                const data = await response.json();
                const statusEl = document.getElementById('whatsapp-status');
                
                if (data.configured) {
                    statusEl.innerHTML = `<div style="color:#10b981;">✅ WhatsApp configurado (${data.provider})</div>`;
                } else {
                    statusEl.innerHTML = '<div style="color:#f59e0b;">⚠️ WhatsApp não configurado. Configure WHATSAPP_PROVIDER no .env</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar status WhatsApp:', error);
            }
        }
        
        async function testWhatsApp() {
            const phone = document.getElementById('test-phone').value;
            if (!phone) {
                alert('Digite um número de telefone!');
                return;
            }
            
            try {
                const response = await fetch('/api/whatsapp/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        to: phone,
                        message: '🎉 Teste Link Mágico V3! Se você recebeu esta mensagem, a integração WhatsApp está funcionando!'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Mensagem enviada com sucesso!');
                } else {
                    alert('Erro ao enviar mensagem: ' + (data.error || 'Desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao enviar mensagem');
            }
        }
        
        async function loadChatGPTStatus() {
            try {
                const response = await fetch('/api/chatgpt/status');
                const data = await response.json();
                const statusEl = document.getElementById('chatgpt-status');
                
                if (data.configured) {
                    statusEl.innerHTML = '<div style="color:#10b981;">✅ ChatGPT configurado e pronto</div>';
                } else {
                    statusEl.innerHTML = '<div style="color:#f59e0b;">⚠️ ChatGPT não configurado. Configure CHATGPT_API_KEY no .env</div>';
                }
                
                // Carregar modelos
                const modelsResponse = await fetch('/api/chatgpt/models');
                const modelsData = await modelsResponse.json();
                const modelsEl = document.getElementById('chatgpt-models');
                
                if (modelsData.length > 0) {
                    modelsEl.innerHTML = modelsData.map(m => `
                        <div style="background:#1e293b; padding:1rem; border-radius:8px; margin-bottom:0.5rem;">
                            <div style="color:#cbd5e1; font-weight:600;">${m.name}</div>
                            <div style="color:#94a3b8; font-size:0.9rem;">${m.description}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar status ChatGPT:', error);
            }
        }
        
        async function testChatGPT() {
            const prompt = document.getElementById('test-prompt').value;
            if (!prompt) {
                alert('Digite uma pergunta!');
                return;
            }
            
            const responseEl = document.getElementById('chatgpt-response');
            responseEl.style.display = 'block';
            responseEl.innerHTML = '<div style="color:#94a3b8;">Gerando resposta...</div>';
            
            try {
                const response = await fetch('/api/chatgpt/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        prompt: prompt,
                        model: 'gpt-4-turbo'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    responseEl.innerHTML = `<div style="color:#cbd5e1;">${data.result.response}</div>`;
                } else {
                    responseEl.innerHTML = `<div style="color:#ef4444;">Erro: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('Erro:', error);
                responseEl.innerHTML = '<div style="color:#ef4444;">Erro ao gerar resposta</div>';
            }
        }
        
        async function saveWhitelabel() {
            const config = {
                companyName: document.getElementById('wl-company').value,
                logoUrl: document.getElementById('wl-logo').value,
                primaryColor: document.getElementById('wl-primary').value,
                secondaryColor: document.getElementById('wl-secondary').value
            };
            
            try {
                const response = await fetch('/api/whitelabel/default', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Configuração salva com sucesso!');
                    updateWhitelabelPreview(config);
                } else {
                    alert('Erro ao salvar: ' + (data.error || 'Desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar configuração');
            }
        }
        
        function updateWhitelabelPreview(config) {
            const preview = document.getElementById('wl-preview');
            preview.innerHTML = `
                <div style="background:linear-gradient(135deg, ${config.primaryColor}, ${config.secondaryColor}); padding:2rem; border-radius:12px;">
                    ${config.logoUrl ? `<img src="${config.logoUrl}" style="max-width:200px; margin-bottom:1rem;">` : ''}
                    <h3 style="color:white; margin:0;">${config.companyName || 'Sua Empresa'}</h3>
                </div>
            `;
        }
        
        async function loadLeadsStats() {
            try {
                // Usar endpoint real /admin/leads
                const response = await fetch('/admin/leads', {
                    headers: {
                        'X-API-Key': 'linkmagico-api-key-2024'
                    }
                });
                const data = await response.json();
                
                if (data.success && data.leads) {
                    const leads = data.leads;
                    
                    // Calcular estatísticas
                    const total = leads.length;
                    
                    // Classificar leads por interesse (simulação baseada em dados disponíveis)
                    const hot = leads.filter(lead => {
                        // Leads com email E telefone são considerados "hot"
                        const telefone = lead.telefone || lead.phone;
                        return lead.email && telefone;
                    }).length;
                    
                    const warm = leads.filter(lead => {
                        // Leads com email OU telefone (mas não ambos) são "warm"
                        const telefone = lead.telefone || lead.phone;
                        return (lead.email || telefone) && !(lead.email && telefone);
                    }).length;
                    
                    const cold = total - hot - warm;
                    
                    // Atualizar estatísticas
                    document.getElementById('leads-total').textContent = total;
                    document.getElementById('leads-hot').textContent = hot;
                    document.getElementById('leads-warm').textContent = warm;
                    document.getElementById('leads-cold').textContent = cold;
                    
                    // Carregar lista (últimos 10 leads)
                    const listEl = document.getElementById('leads-list');
                    const recentLeads = leads.slice(-10).reverse(); // Últimos 10, mais recentes primeiro
                    
                    if (recentLeads.length > 0) {
                        listEl.innerHTML = recentLeads.map(lead => {
                            // Determinar classificação
                            let classification = 'cold';
                            let bgColor = '#3b82f6';
                            
                            // Usar campos corretos: nome, telefone (não name, phone)
                            const nome = lead.nome || lead.name || '';
                            const telefone = lead.telefone || lead.phone || '';
                            
                            if (lead.email && telefone) {
                                classification = 'hot';
                                bgColor = '#ef4444';
                            } else if (lead.email || telefone) {
                                classification = 'warm';
                                bgColor = '#f59e0b';
                            }
                            
                            // Formatar data
                            const date = new Date(lead.timestamp);
                            const dateStr = date.toLocaleDateString('pt-BR');
                            const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            
                            return `
                                <div style="background:#1e293b; padding:1rem; border-radius:8px; margin-bottom:0.5rem; cursor:pointer;" onclick="showLeadDetails('${lead.id}')">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div style="flex:1;">
                                            <div style="color:#cbd5e1; font-weight:600; margin-bottom:0.25rem;">${nome || 'Visitante'}</div>
                                            <div style="color:#94a3b8; font-size:0.85rem;">
                                                ${lead.email ? `📧 ${lead.email}` : ''} 
                                                ${lead.email && telefone ? ' | ' : ''}
                                                ${telefone ? `📱 ${telefone}` : ''}
                                            </div>
                                            <div style="color:#64748b; font-size:0.75rem; margin-top:0.25rem;">
                                                🕒 ${dateStr} às ${timeStr}
                                            </div>
                                        </div>
                                        <div style="background:${bgColor}; color:white; padding:0.4rem 0.8rem; border-radius:6px; font-size:0.8rem; font-weight:600;">
                                            ${classification.toUpperCase()}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        listEl.innerHTML = '<p style="color:#94a3b8;">Nenhum lead capturado ainda.</p>';
                    }
                    
                    console.log(`📊 Leads V2.0 carregados: ${total} total (${hot} hot, ${warm} warm, ${cold} cold)`);
                }
            } catch (error) {
                console.error('Erro ao carregar leads:', error);
                document.getElementById('leads-list').innerHTML = '<p style="color:#ef4444;">Erro ao carregar leads. Verifique a conexão.</p>';
            }
        }
        
        // Função para carregar leads no dashboard principal
        async function loadDashboardLeads() {
            try {
                const response = await fetch('/admin/leads', {
                    headers: {
                        'X-API-Key': 'linkmagico-api-key-2024'
                    }
                });
                const data = await response.json();
                
                if (data.success && data.leads) {
                    const leads = data.leads;
                    const totalLeads = leads.length;
                    
                    // Calcular leads de hoje
                    const today = new Date().toDateString();
                    const leadsToday = leads.filter(lead => {
                        const leadDate = new Date(lead.timestamp).toDateString();
                        return leadDate === today;
                    }).length;
                    
                    // Calcular conversas e mensagens
                    let totalConversations = 0;
                    let totalMessages = 0;
                    let conversationsToday = 0;
                    let messagesToday = 0;
                    
                    leads.forEach(lead => {
                        if (lead.conversations && Array.isArray(lead.conversations)) {
                            lead.conversations.forEach(conv => {
                                totalConversations++;
                                
                                // Verificar se a conversa é de hoje
                                if (conv.timestamp) {
                                    const convDate = new Date(conv.timestamp).toDateString();
                                    if (convDate === today) {
                                        conversationsToday++;
                                    }
                                }
                                
                                // Contar mensagens
                                if (conv.messages && Array.isArray(conv.messages)) {
                                    const msgCount = conv.messages.length;
                                    totalMessages += msgCount;
                                    
                                    // Contar mensagens de hoje
                                    conv.messages.forEach(msg => {
                                        if (msg.timestamp) {
                                            const msgDate = new Date(msg.timestamp).toDateString();
                                            if (msgDate === today) {
                                                messagesToday++;
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });
                    
                    // Atualizar dashboard
                    document.getElementById('totalLeads').textContent = totalLeads;
                    document.getElementById('leadsToday').textContent = leadsToday;
                    document.getElementById('conversationsToday').textContent = conversationsToday;
                    document.getElementById('messagesSent').textContent = messagesToday;
                    
                    console.log(`📊 Dashboard atualizado: ${totalLeads} leads (${leadsToday} hoje), ${conversationsToday} conversas hoje, ${messagesToday} mensagens hoje`);
                }
            } catch (error) {
                console.error('Erro ao carregar leads do dashboard:', error);
                document.getElementById('totalLeads').textContent = '0';
                document.getElementById('leadsToday').textContent = '0';
            }
        }
        
        // Função para mostrar detalhes do lead em modal
        function showLeadDetails(leadId) {
            fetch('/admin/leads', {
                headers: {
                    'X-API-Key': 'linkmagico-api-key-2024'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.leads) {
                    const lead = data.leads.find(l => l.id === leadId);
                    if (lead) {
                        const date = new Date(lead.timestamp);
                        const dateStr = date.toLocaleDateString('pt-BR', { 
                            day: '2-digit', 
                            month: 'long', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        // Usar campos corretos do lead
                        const nome = lead.nome || lead.name || 'Não informado';
                        const telefone = lead.telefone || lead.phone || 'Não informado';
                        const url = lead.url_origem || lead.url || 'Não disponível';
                        
                        const modalContent = `
                            <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; display:flex; align-items:center; justify-content:center;" onclick="this.remove()">
                                <div style="background:#1e293b; padding:2rem; border-radius:16px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto;" onclick="event.stopPropagation()">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                                        <h2 style="color:#60a5fa; margin:0;">📋 Detalhes do Lead</h2>
                                        <button onclick="this.closest('[style*=fixed]').remove()" style="background:#ef4444; color:white; border:none; padding:0.5rem 1rem; border-radius:8px; cursor:pointer; font-weight:600;">
                                            ✕ Fechar
                                        </button>
                                    </div>
                                    
                                    <div style="background:#334155; padding:1.5rem; border-radius:12px; margin-bottom:1rem;">
                                        <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">Nome</div>
                                        <div style="color:#cbd5e1; font-size:1.1rem; font-weight:600;">${nome}</div>
                                    </div>
                                    
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem;">
                                        <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">📧 Email</div>
                                            <div style="color:#cbd5e1; font-weight:600;">${lead.email || 'Não informado'}</div>
                                        </div>
                                        <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">📱 Telefone</div>
                                            <div style="color:#cbd5e1; font-weight:600;">${telefone}</div>
                                        </div>
                                    </div>
                                    
                                    <div style="background:#334155; padding:1.5rem; border-radius:12px; margin-bottom:1rem;">
                                        <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">💬 Mensagem</div>
                                        <div style="color:#cbd5e1; line-height:1.6;">${lead.message || 'Nenhuma mensagem'}</div>
                                    </div>
                                    
                                    <div style="background:#334155; padding:1.5rem; border-radius:12px; margin-bottom:1rem;">
                                        <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">🕒 Data de Captura</div>
                                        <div style="color:#cbd5e1; font-weight:600;">${dateStr}</div>
                                    </div>
                                    
                                    <div style="background:#334155; padding:1.5rem; border-radius:12px;">
                                        <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:0.5rem;">🔗 URL de Origem</div>
                                        <div style="color:#60a5fa; word-break:break-all;">${url}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        document.body.insertAdjacentHTML('beforeend', modalContent);
                    }
                }
            })
            .catch(error => {
                console.error('Erro ao carregar detalhes do lead:', error);
                alert('Erro ao carregar detalhes do lead');
            });
        }
        
        async function exportLeads() {
            try {
                // Buscar todos os leads
                const response = await fetch('/admin/leads', {
                    headers: {
                        'X-API-Key': 'linkmagico-api-key-2024'
                    }
                });
                const data = await response.json();
                
                if (data.success && data.leads && data.leads.length > 0) {
                    // Criar CSV
                    const headers = ['ID', 'Nome', 'Email', 'Telefone', 'Mensagem', 'URL', 'Data/Hora'];
                    const rows = data.leads.map(lead => {
                        const date = new Date(lead.timestamp);
                        const dateStr = date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR');
                        
                        // Usar campos corretos (nome, telefone, url_origem)
                        const nome = lead.nome || lead.name || '';
                        const telefone = lead.telefone || lead.phone || '';
                        const url = lead.url_origem || lead.url || '';
                        
                        return [
                            lead.id || '',
                            nome,
                            lead.email || '',
                            telefone,
                            (lead.message || '').replace(/"/g, '""'), // Escapar aspas
                            url,
                            dateStr
                        ].map(field => `"${field}"`).join(',');
                    });
                    
                    const csv = [headers.join(','), ...rows].join('\n');
                    
                    // Criar blob e download
                    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' }); // BOM para UTF-8
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    const now = new Date();
                    const filename = `leads_linkmagico_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours()}${now.getMinutes()}.csv`;
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showToast(`✅ ${data.leads.length} leads exportados com sucesso!`, 'success');
                } else {
                    showToast('⚠️ Nenhum lead disponível para exportar', 'warning');
                }
            } catch (error) {
                console.error('Erro ao exportar leads:', error);
                showToast('❌ Erro ao exportar leads', 'error');
            }
        }
        
        // ===== FUNÇÕES DE BACKUP =====
        async function createBackup() {
            try {
                showToast('💾 Criando backup...', 'info');
                
                const response = await fetch('/admin/leads/backup/create', {
                    method: 'POST',
                    headers: {
                        'X-API-Key': 'linkmagico-api-key-2024',
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('✅ Backup criado com sucesso!', 'success');
                    loadBackups(); // Recarregar lista
                } else {
                    showToast('❌ Erro ao criar backup: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erro ao criar backup:', error);
                showToast('❌ Erro ao criar backup', 'error');
            }
        }
        
        async function loadBackups() {
            try {
                const response = await fetch('/admin/leads/backup/list', {
                    headers: {
                        'X-API-Key': 'linkmagico-api-key-2024'
                    }
                });
                
                const data = await response.json();
                
                const container = document.getElementById('backups-list');
                
                if (data.success && data.backups && data.backups.length > 0) {
                    container.innerHTML = data.backups.map(backup => {
                        const date = new Date(backup.timestamp);
                        const dateStr = date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR');
                        const sizeKB = (backup.size / 1024).toFixed(2);
                        
                        const typeLabels = {
                            'manual': '👤 Manual',
                            'daily': '⏰ Diário',
                            'startup': '🚀 Startup',
                            'shutdown': '🛑 Shutdown',
                            'pre-restore': '⚠️ Pré-restauração'
                        };
                        
                        const typeLabel = typeLabels[backup.type] || backup.type;
                        
                        return `
                            <div style="background:#1e293b; padding:1rem; border-radius:8px; margin-bottom:0.75rem; border-left:4px solid #3b82f6;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                                    <div>
                                        <div style="color:#cbd5e1; font-weight:600; margin-bottom:0.25rem;">${typeLabel}</div>
                                        <div style="color:#94a3b8; font-size:0.85rem;">${dateStr}</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="color:#60a5fa; font-weight:600;">${backup.leadsCount} leads</div>
                                        <div style="color:#94a3b8; font-size:0.85rem;">${sizeKB} KB</div>
                                    </div>
                                </div>
                                <button onclick="restoreBackup('${backup.filename}')" style="background:#10b981; color:white; border:none; padding:0.5rem 1rem; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:600; width:100%;">
                                    ♻️ Restaurar Este Backup
                                </button>
                            </div>
                        `;
                    }).join('');
                    
                    console.log(`📦 ${data.backups.length} backups carregados`);
                } else {
                    container.innerHTML = '<p style="color:#94a3b8;">Nenhum backup disponível ainda.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar backups:', error);
                document.getElementById('backups-list').innerHTML = '<p style="color:#ef4444;">Erro ao carregar backups</p>';
            }
        }
        
        async function restoreBackup(filename) {
            if (!confirm(`⚠️ Tem certeza que deseja restaurar este backup?\n\nIsso irá substituir todos os leads atuais!\n\nUm backup do estado atual será criado antes da restauração.`)) {
                return;
            }
            
            try {
                showToast('♻️ Restaurando backup...', 'info');
                
                const response = await fetch('/admin/leads/backup/restore', {
                    method: 'POST',
                    headers: {
                        'X-API-Key': 'linkmagico-api-key-2024',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filename })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`✅ Backup restaurado! ${result.leadsCount} leads recuperados.`, 'success');
                    
                    // Recarregar dados
                    loadBackups();
                    loadLeadsStats();
                    loadDashboardLeads();
                } else {
                    showToast('❌ Erro ao restaurar backup: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erro ao restaurar backup:', error);
                showToast('❌ Erro ao restaurar backup', 'error');
            }
        }
        
        // Carregar leads do dashboard ao iniciar
        window.addEventListener('DOMContentLoaded', () => {
            loadDashboardLeads();
            // Atualizar a cada 30 segundos
            setInterval(loadDashboardLeads, 30000);
        });
    </script>
    </body>
</html>
